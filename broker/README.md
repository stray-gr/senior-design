# Table of Contents
1. [Prerequisites](#prerequisites)
2. [TLS Cert Creation](#tls-cert-creation)
3. [Create Users Script Reference](#create-users-script-reference)
4. [MQTTX Pub/Sub](#mqttx-pubsub)

# Prerequisites
Make sure to have the following software installed:
- [Rancher Desktop](https://rancherdesktop.io/)
- [Mosquitto Message Broker](https://mosquitto.org/download/)
- [MQTTX CLI Tool](https://mqttx.app/cli)

# TLS Cert Creation
First, create the certificate authority's private key and cert. Make sure to set `<duration>` to the number of days the key and cert should be valid for: 
```
openssl req -new -x509 -days <duration> -extensions v3_ca -keyout ca.key -out ca.crt
```

Next, create the broker's private key and certificate signing request (CSR):
1. Create server private key: `openssl genrsa -out broker.key 2048`
2. Create the CSR: `openssl req -out broker.csr -key broker.key -new`. 
    - Make sure to set **Common Name** to the message broker's hostname (e.g. "My-PC-Name")

Finally, sign the CSR using the certificate authority we initially created. Make sure to set `<duration>` to the number of days the broker's private key and cert should be valid for: 
```
openssl x509 -req -in broker.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out broker.crt -days <duration>
```

# Create Users Script Reference
## Overview
Here's a brief overview of what the script does:
1. The script creates the *clock* user and password, which only has write access to the *pulse* topic
    > Note that each password is generated by using openssl's `rand` command to create a random string of 32 characters
2. The script creates an arbitrary number of *device* users and their passwords, which only have *pulse* topic read access and *data/#* topic write access
    > Note that the **#** in *data/#* matches any topic that begins with *data/*. As a result, this pattern gives each user write access to the *data/sensor* and *data/lwt* topics
3. The script creates the *server* user and password, which only has read access to the *data/#* topic
4. The acl_file and users.txt file are then given read-write-execute permissions only for the current user
5. Once the script is done running, the following files can then be viewed in the creds/ folder:
    - **acl_file** - defines access control for each user
    - **plain.txt** - contains user names and plain text passwords (maps each user/password)
    - **users.txt** - contains user names and hashed passwords (used by server for auth)

## Usage
1. Open a terminal and change the current working directory to the broker/ folder
2. Give the script execute permissions by running:  `chmod a+x create_users.sh`
3. To create n device users, along with the clock and server users, run: `./create_users.sh n`. For example: `./create_users.sh 10` will create 10 device users along with the clock and server users.

# MQTTX Pub/Sub
To start Mosquitto locally, open a terminal from the repo root and run: `mosquitto -c broker/mosquitto.conf`

To test read permissions for a given user or topic, use the following command format:
```bash 
mqttx sub -h {My-PC-Name} -p 8885 -l mqtts -v 5 --ca broker/certs/ca.crt -u {USER} -P {PASSWORD} -t "{TOPIC}"
```

To test write permissions for a given user or topic, use the following command format:
```bash 
mqttx pub -h {My-PC-Name} -p 8885 -l mqtts -V 5 --ca broker/certs/ca.crt -u {USER} -P {PASSWORD} -t "{TOPIC}" -m "{MESSAGE}"
```