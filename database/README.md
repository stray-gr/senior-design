# Table of Contents
1. [Prerequisites](#prerequisites)
2. [TLS Cert Creation](#tls-cert-creation)
3. [Database Set Up](#database-set-up)
4. [Dockerfile](#dockerfile)

# Prerequisites
Make sure to have the following software installed:
- Openssl
- Rancher Desktop
    - If you are on Windows, make sure to install as admin

# TLS Cert Creation
1. `cd` into the database/ folder and create the certs/ folder
2. `cd` into the newly created certs/ folder 
3. Create the certificate authority's private key and cert. Make sure to set `<duration>` to the number of days the key and cert should be valid for: 
    ```
    openssl req -new -x509 -days <duration> -extensions v3_ca -keyout ca.key -out ca.crt
    ```
5. Create the postgresql server's private key: `openssl genrsa -out server.key 2048`
6. Create the server's certificate signing request (CSR): `openssl req -out server.csr -key server.key -new` 
    - Make sure to set **Common Name** to the message server's hostname (e.g. "My-PC-Name")
7. Sign the CSR using the certificate authority we initially created. Make sure to set `<duration>` to the number of days the broker's private key and cert should be valid for: 
    ```
    openssl x509 -req -in server.csr -extfile <(printf "subjectAltName=DNS:My-PC-Name") -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days <duration>
    ```
8. View the final result using `openssl x509 -noout -text -in server.crt`

# Database Set Up
### Start Database Container using Docker Compose
1. `cd` into the database/ folder and the example.env file into a .env file
2. Set the password of the 'postgres' user. This password will be used when connecting remotely to the container as the database's admin
3. Start Rancher desktop
    - If you are on Windows:
        1. Go to `Preferences > WSL > Proxy` and enable the *WSL Proxy*
        2. Below the *WSL Proxy* option is a *No proxy hostname list*. Remove `0.0.0.0/8` from this list
2. In the project repo's root directory, run `docker-compose build` to build the container
3. Run `docker-compose up` to start the container
4. In another terminal, run `docker ps` to find the CONTAINER ID. This will be used to access the container later

### Add Facility Schema and Tables
1. Run `docker exec -it {CONTAINER ID} bash` to open a bash shell within the container as the 'postgres' user
2. In the container's bash shell, run `createdb sddb` to create the database (sddb is the database name)
3. To connect to the newly created database, run `psql sddb` 
4. Issue the following commands in the psql shell to create the 'data' schema and its 'facility' and 'sensor' data tables:
    ```sql
    create schema data; 
    create table data.facility (
        facility_id SERIAL PRIMARY KEY,
        facility_name VARCHAR(128)
    );
    INSERT INTO data.facility (facility_name) VALUES ('Facility 1'), ('Facility 2');
    create table data.sensor (
        entry_id SERIAL NOT NULL, facility_id SERIAL,
        device VARCHAR(64) NOT NULL, temp REAL, rh REAL, epoch BIGINT NOT NULL,
        FOREIGN KEY (facility_id) REFERENCES data.facility(facility_id),
        PRIMARY KEY (entry_id, facility_id)
    );
    create index idx_epoch on data.sensor (epoch); 
    ```
5. Type `\q` to exit the psql shell 

### Create Facility User
1. Generate the new user's password by running `openssl rand -base64 40 | tr -d "=+/" | cut -c1-32`
2. Run `docker exec -it {CONTAINER ID} psql sddb` to open a psql shell within the container
3. Issue the following commands in the psql shell to create a database user for facility n with INSERT only permissions. Make sure to replace {password} with the password generated by openssl:
    ```sql
    create role facility_n with login password '{password}';
    grant connect on database sddb to facility_n;
    grant usage on schema data to facility_n;
    grant insert on data.sensor to facility_n;
    grant select on data.sensor to facility_n;
    ```
4. Since the sensor data table has the 'entry_id' column set to the SERIAL type, issue the following psql command to find its serial sequence:
    ```sql
    select pg_get_serial_sequence('data.sensor', 'entry_id');
    ```
5. Grant the database user permission to use the table's serial sequence by replacing {seq_id} with the ID from above and running the following psql command:
    ```sql
    grant usage on sequence {seq_id} to facility_n;
    ```
6. Exit the psql shell using `\q`
7. To test the user's connection, run `docker exec -it {CONTAINER ID} psql -d sddb -U facility_n -W`

### Create API User
1. Generate the new user's password by running `openssl rand -base64 40 | tr -d "=+/" | cut -c1-32`
2. Run `docker exec -it {CONTAINER ID} psql sddb` to open a psql shell within the container
3. Issue the following commands in the psql shell to create an api user with SELECT only permissions. Make sure to replace {password} with the password generated by openssl:
    ```sql
    create role api with login password '{password}';
    grant connect on database sddb to api;
    grant usage on schema data to api;
    grant select on all tables in schema data to api;
    ```
5. Exit the psql shell using `\q`
6. To test the user's connection, run `docker exec -it {CONTAINER ID} psql -d sddb -U api -W`

### Other Useful PSQL Commands
- `SET ROLE username;` changes current user
- `SELECT current_user;` returns current user
- `TRUNCATE data.sensor RESTART IDENTITY CASCADE;` clears the sensor data table 
- `DROP SCHEMA test CASCADE;` removes a schema and its tables
- `ALTER ROLE user_name WITH PASSWORD 'new_password';` changes a user's password
- `ALTER TABLE tble ALTER COLUMN col TYPE REAL;` changes a column's type
- `\conninfo` lists connection info

### Useful links
- https://www.postgresql.org/docs/16/index.html
- https://www.geeksforgeeks.org/postgresql-create-schema/
- https://stackoverflow.com/a/41737829 OR https://stackoverflow.com/a/26726006
- https://www.slingacademy.com/article/grant-privileges-user-postgresql/
- https://stackoverflow.com/a/30509741

# Dockerfile
### Purpose
- The database's Dockerfile is to be used for potential deployment to hardware or the cloud in an operating system agnostic way
- Docker also utilizes Docker Volumes to persist data. This approach is also more file system agnostic. To work with these volumes, see the output from `docker volumes --help`

### Step-by-Step Explanation
- For a step-by-step explanation of each command in the Dockerfile, refer to the file's comments
- Any ports mapped from the container to the host machine can be found in the compose.yaml file at the repo's root 
- WARNING: There is no `ENTRYPOINT` or `CMD` in this Dockerfile. Adding one of these commands will lead to permission issues between docker volumes and the docker container