# Table of Contents
1. [Installation](#installation)
    - [Prerequisites](#prerequisites)
    - [From Current Repo](#from-current-repo)
    - [From Scratch](#from-scratch)
2. [Wokwi CLI Emulation](#wokwi-cli-emulation)
3. [Notes](#notes)
4. [Protobuf Formats](#protobuf-formats)
5. [TODO](#todo)

# Installation
## Prerequisites
Before starting with either form of installation, make the following requirements are available:
- WSL2 or a Unix-like OS
    > Make sure to install the WSL plugin for VS code if you're on Windows
- VS Code w/ the PlatformIO IDE and vscode-proto3 plugins installed
- Protobuf compiler (protoc) and protobuf-c
    > This can be done via your OS package manager, such as `apt` or `brew`
- Wokwi CLI
- MQTTX CLI tool

Here are some useful links for installing the prerequisites:
- [Platform IDE Plugin Installation](https://docs.platformio.org/en/latest/integration/ide/vscode.html#installation)
- [Wokwi CLI Installation](https://docs.wokwi.com/wokwi-ci/cli-installation)
- [Wokwi CLI Set Up](https://docs.wokwi.com/wokwi-ci/cli-usage) (Make sure to include the API token in your shell's environment)
- [MQTTX CLI Tool Installation](https://mqttx.app/cli)

## From Current Repo
To set up the current ESP-IDF project using PlatformIO:
1. Open the *firmware* folder in VS Code. The PlatformIO plugin should then automatically recognize the project
2. Download the Mosquitto Public Test Broker's CA cert from [this link](https://test.mosquitto.org/ssl/mosquitto.org.crt)
3. Move the downloaded cert into the `src` folder and rename it to *ca.crt*
4. Rename [example_config.h](./src/example_config.h) to *config.h*. This header file contains project configuration details and secrets

## From Scratch
To create your own ESP-IDF project using PlatfromIO, follow these steps:
1. [Create an ESP-IDF project](https://docs.platformio.org/en/latest/tutorials/espressif32/espidf_debugging_unit_testing_analysis.html#setting-up-the-project) using the Platform IO plugin
2. In your newly created project's [sdkconfig](./sdkconfig.esp32dev), add `CONFIG_MQTT_PROTOCOL_5=y` under the `ESP-MQTT Configurations` section. This will allow you to use MQTT v5
3. Rename [example_config.h](./src/example_config.h) to *config.h*. This header file will contain any project configuration details and secrets. Feel free to make any changes
4. Write your MQTT message definitions using protobuf. Then compile them by running: `protoc --c_out=. file_name.proto`, where *file_name* is the name of your .proto file
5. Move the .c file generated by `protoc` into the src/ folder and move the .h file into the include/ folder
6. Start developing your firmware
7. [Set up](https://docs.wokwi.com/wokwi-ci/cli-usage) the Wokwi CLI. Make sure to include the API token in your shell's environment
8. Ensure you also have a [wokwi.toml](./wokwi.toml) in your project's root folder. This TOML file will the the Wokwi CLI where your firmware is located
9. Add a [diagram.json](./diagram.json) in your project's root folder. This JSON file will tell the Wokwi API how to set up the hardware for your project.
    > For more information regarding how to customize and configure your own *diagram.json*, refer to [this documentation](https://docs.wokwi.com/diagram-format)

# Wokwi CLI Emulation
To run the Wokwi CLI Emulator:
1. Build the firmware using by clicking the checkmark in the bottom toolbar
2. Open a new terminal and **subscribe to the *Data* topic** by running the command below:
    ```bash 
    mqttx sub -h test.mosquitto.org -p 8883 --ca src/ca.crt -l mqtts -V 5 -Pp msg.proto -Pmn "Data" -t "6137cde4893c59f76f005a8123d8e8e6"
    ```
3. Open a new terminal and **subscribe to the *LWT* topic** by running the command below:
    ```bash 
    mqttx sub -h test.mosquitto.org -p 8883 --ca src/ca.crt -l mqtts -V 5 -Pp msg.proto -Pmn "LWT" -t "7ae7ce7048de53dc01e9ecaef1be401e"
    ```
4. Open a new terminal and run the `wokwi-cli --timeout 60000` command. This will start the simulation, which will listen to the pulse topic and publish to the data topic. The simulation will then timeout after 1 minute
5. Open a new terminal and **publish to the *Pulse* topic** by running the command below. Note that you should have **four** terminals running by now:
    ```bash 
    mqttx pub -h test.mosquitto.org -p 8883 --ca src/ca.crt -l mqtts -V 5 -t "5d4ff171536e1f3c63afcf6709574876" -m ""
    ```
6. Check the terminal subcribed to the data topic for new messages
7. Hit `CTRL + C` in the emulator terminal to shut it down. Then wait about 1 minute for the following message to appear in the LWT terminal: *d265f27851d6b048e64576475674922f*. This demonstrates a successful LWT delay
    > It should technically take 3 seconds for the message to display. However, the public message broker being used can take a while to deliver LWT messages

# Notes
- The LWT message is *username* hashed by MD5, which is the username of the emulated device. Additionally, each topic name was also hashed by MD5 to prevent any name collisions with anyone else's topics on the public test broker being used.

# Protobuf Formats
### Time Pulse Messages
- **Publisher:** Local Server Chron Job
- **Subscribers:** Each ESP32
- **QoS:** 0
- **Special Properties:** none
- **Payload:** empty

### LWT Messages
- **Publishers:** Each ESP32
- **Subscriber:** Local Server LWT Queue
- **QoS:** 1
- **Special properties:** 1 minute delay
- **Payload:**
    ```proto
    message LWT {
        string device = 1;  // Device username
    }
    ```

### Data Messages
- **Publishers:** Each ESP32
- **Subscriber:** Local Server Data Queue
- **QoS:** 1
- **Special properties:** none
- **Payload:**
    ```proto
    message Data {
        string device = 1;   // Device username
        int32    temp = 2;   // Temperature
        float      rh = 3;   // Relative Humidity
        int64   epoch = 4;   // Unix Epoch (time_t seconds)
    }
    ```
